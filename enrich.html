<!DOCTYPE html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hedonicum ‚Äî Grape Enrichment</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,sans-serif;padding:24px;max-width:600px;margin:0 auto}
  h1{font-size:1.5rem;margin-bottom:4px;color:#fbbf24}
  .sub{color:#94a3b8;margin-bottom:24px;font-size:0.9rem}
  button{background:#d97706;color:#0f172a;border:none;padding:14px 28px;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;width:100%;transition:all 0.2s}
  button:hover{background:#f59e0b}
  button:disabled{opacity:0.4;cursor:not-allowed}
  .progress{margin-top:20px;background:#1e293b;border-radius:8px;height:8px;overflow:hidden}
  .progress-bar{height:100%;background:linear-gradient(90deg,#d97706,#fbbf24);transition:width 0.3s;width:0%}
  .stats{display:flex;justify-content:space-between;margin-top:8px;font-size:0.8rem;color:#94a3b8}
  #log{margin-top:16px;background:#1e293b;border-radius:12px;padding:16px;font-family:'SF Mono',Monaco,monospace;font-size:0.8rem;white-space:pre-wrap;min-height:120px;max-height:50vh;overflow-y:auto;line-height:1.6}
  .s{color:#2dd4bf}.e{color:#f87171}.i{color:#fbbf24}.w{color:#94a3b8}
</style></head>
<body>
<h1>üçá Grape Enrichment</h1>
<p class="sub">Backfill grape varieties for all wines using AI sommelier identification.</p>
<button id="btn" onclick="start()">Start Enrichment</button>
<div class="progress"><div class="progress-bar" id="bar"></div></div>
<div class="stats"><span id="stat-left">‚Äî</span><span id="stat-done">‚Äî</span></div>
<div id="log"></div>

<script>
const log = document.getElementById('log');
const btn = document.getElementById('btn');
const bar = document.getElementById('bar');
let running = false, totalEnriched = 0;

function L(msg, cls='i') {
  const d = document.createElement('div');
  d.className = cls;
  d.textContent = msg;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
}

async function processBatch() {
  const res = await fetch('/api/enrich-grapes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({})
  });
  return await res.json();
}

async function start() {
  if (running) return;
  running = true;
  btn.disabled = true;
  btn.textContent = 'Running...';
  log.innerHTML = '';
  totalEnriched = 0;

  L('Starting grape enrichment...');

  let batchNum = 0;
  while (true) {
    batchNum++;
    L(`\nBatch ${batchNum}: processing up to 15 wines...`, 'w');

    try {
      const data = await processBatch();

      if (data.error) {
        L(`Error: ${data.error}`, 'e');
        if (data.raw) L(`Raw: ${data.raw}`, 'e');
        break;
      }

      if (data.done && data.enriched === 0 && !data.results?.length) {
        L('‚úÖ All wines already have grape data!', 's');
        break;
      }

      totalEnriched += data.enriched;

      // Log each wine
      if (data.results) {
        data.results.forEach(r => L(`  ‚úì ${r.name} ‚Üí ${r.grape}`, 's'));
      }

      const total = totalEnriched + (data.remaining || 0);
      const pct = total > 0 ? Math.round((totalEnriched / total) * 100) : 100;
      bar.style.width = pct + '%';
      document.getElementById('stat-left').textContent = `${data.remaining || 0} remaining`;
      document.getElementById('stat-done').textContent = `${totalEnriched} enriched`;

      L(`Batch ${batchNum}: ${data.enriched}/${data.batch_size} updated, ${data.remaining} remaining`, 'i');

      if (data.done || data.remaining <= 0) {
        L(`\nüéâ Done! ${totalEnriched} wines enriched total.`, 's');
        L('Refresh Hedonicum to see grapes populated.', 's');
        bar.style.width = '100%';
        break;
      }

      // Brief pause between batches
      await new Promise(r => setTimeout(r, 1000));

    } catch (err) {
      L(`Request failed: ${err.message}`, 'e');
      L('Retrying in 3s...', 'w');
      await new Promise(r => setTimeout(r, 3000));
    }
  }

  running = false;
  btn.disabled = false;
  btn.textContent = 'Run Again';
}
</script>
</body></html>
