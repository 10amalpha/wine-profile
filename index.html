<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Hedonicum</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#080f1e;color:#e2e8f0;min-height:100vh;min-height:100dvh;padding-bottom:80px}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;display:flex;background:rgba(8,15,30,0.95);border-top:1px solid rgba(45,212,191,0.1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:90;padding:8px 0;padding-bottom:max(8px,env(safe-area-inset-bottom))}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;cursor:pointer;color:#475569;font-size:0.65rem;transition:color 0.2s;border:none;background:none}
.nav-item.active{color:#2dd4bf}
.nav-item .nav-icon{font-size:1.4rem}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:rgba(45,212,191,0.95);color:#0a1628;padding:12px 24px;border-radius:12px;font-size:0.9rem;font-weight:600;z-index:200;transition:transform 0.3s ease;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.toast.show{transform:translateX(-50%) translateY(0)}
.screen{display:none;padding:16px}
.screen.active{display:block}
.scan-hero{text-align:center;padding:20px 0 16px}
.scan-hero h1{font-size:1.3rem;background:linear-gradient(135deg,#2dd4bf,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:2px}
.scan-hero p{color:#475569;font-size:0.75rem}
.scan-cards{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.scan-card{background:rgba(15,25,45,0.8);border:1.5px solid rgba(45,212,191,0.15);border-radius:16px;padding:24px 20px;display:flex;align-items:center;gap:16px;cursor:pointer;transition:all 0.2s;-webkit-user-select:none}
.scan-card:active{transform:scale(0.98);border-color:rgba(45,212,191,0.4)}
.scan-card-icon{font-size:2.2rem;flex-shrink:0}
.scan-card-text h3{font-size:1rem;font-weight:700;color:#e2e8f0;margin-bottom:3px}
.scan-card-text p{font-size:0.8rem;color:#64748b;line-height:1.4}
/* Taste fingerprint */
.taste-card{margin-top:20px;background:rgba(15,25,45,0.6);border:1px solid rgba(45,212,191,0.08);border-radius:16px;padding:18px 16px;position:relative;overflow:hidden}
.taste-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#2dd4bf,transparent)}
.taste-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:14px}
.taste-title{font-size:0.8rem;font-weight:700;color:#2dd4bf;text-transform:uppercase;letter-spacing:0.5px}
.taste-subtitle{font-size:0.7rem;color:#334155}
.taste-stats{display:flex;justify-content:space-between;margin-bottom:14px}
.taste-stat{text-align:center;flex:1}
.ts-num{font-size:1.3rem;font-weight:800;color:#e2e8f0;line-height:1}
.ts-label{font-size:0.6rem;color:#475569;text-transform:uppercase;letter-spacing:0.3px;margin-top:2px}
.taste-tags{display:flex;align-items:center;gap:6px;margin-top:8px;flex-wrap:wrap}
.taste-tag-label{font-size:0.6rem;color:#334155;text-transform:uppercase;letter-spacing:0.3px;min-width:65px}
.taste-tag{font-size:0.7rem;color:#64748b;background:rgba(45,212,191,0.06);border:1px solid rgba(45,212,191,0.1);padding:3px 10px;border-radius:10px}
input[type="file"]{display:none}
.pairing-section{margin-top:20px}
.pairing-section label{display:block;font-size:0.75rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.pairing-input{width:100%;padding:14px 16px;border-radius:14px;border:1.5px solid rgba(45,212,191,0.15);background:rgba(15,25,45,0.8);color:#e2e8f0;font-size:1rem;outline:none}
.pairing-input:focus{border-color:rgba(45,212,191,0.4)}
.pairing-input::placeholder{color:#334155}
.photo-strip{display:flex;gap:8px;margin-top:12px;overflow-x:auto;padding:4px 0;-webkit-overflow-scrolling:touch}
.photo-thumb{position:relative;width:72px;height:72px;border-radius:12px;overflow:hidden;flex-shrink:0;border:2px solid rgba(45,212,191,0.2)}
.photo-thumb img{width:100%;height:100%;object-fit:cover}
.photo-thumb-x{position:absolute;top:3px;right:3px;width:20px;height:20px;background:rgba(0,0,0,0.7);color:#ef4444;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.65rem;cursor:pointer}
.photo-thumb-num{position:absolute;bottom:3px;left:3px;width:18px;height:18px;background:rgba(45,212,191,0.9);color:#0a1628;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700}
.add-more-thumb{width:72px;height:72px;border-radius:12px;border:2px dashed rgba(45,212,191,0.2);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#2dd4bf;cursor:pointer;flex-shrink:0}
.analyze-btn{width:100%;margin-top:14px;padding:16px;border-radius:14px;border:none;background:linear-gradient(135deg,#2dd4bf,#06b6d4);color:#0a1628;font-size:1rem;font-weight:700;cursor:pointer}
.analyze-btn:active{opacity:0.9}
.clear-link{text-align:center;margin-top:10px;color:#64748b;font-size:0.8rem;cursor:pointer;padding:8px}
.scan-status{text-align:center;padding:30px 0;color:#94a3b8;font-size:0.9rem}
.spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(45,212,191,0.3);border-top-color:#2dd4bf;border-radius:50%;animation:spin 0.7s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.result-section{margin-top:16px}
.result-header{font-size:0.8rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid rgba(30,41,59,0.5)}
.result-header span{color:#2dd4bf;font-weight:700}
.result-card{background:rgba(15,25,45,0.8);border:1.5px solid rgba(45,212,191,0.12);border-radius:12px;padding:12px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:10px}
.result-card.matched{border-color:rgba(45,212,191,0.35)}
.result-left{flex:1;min-width:0}
.result-name{font-size:0.95rem;font-weight:700;color:#e2e8f0;margin-bottom:2px}
.result-sub{font-size:0.78rem;color:#64748b}
.result-pairing{font-size:0.78rem;color:#2dd4bf;margin-top:2px}
.result-right{text-align:center;flex-shrink:0}
.result-score{font-size:1.5rem;font-weight:800;color:#2dd4bf;line-height:1}
.result-reorder{font-size:0.65rem;margin-top:2px}
.result-reorder.yes{color:#2dd4bf}
.result-reorder.no{color:#ef4444}
.result-reorder.maybe{color:#f59e0b}
.result-new{font-size:0.72rem;color:#475569;font-style:italic}
.bottle-flow{text-align:center;padding:20px 0}
.bottle-preview{margin:16px auto;max-width:200px}
.bottle-preview img{width:100%;border-radius:14px;border:2px solid rgba(45,212,191,0.2)}
.bottle-status{color:#94a3b8;font-size:0.9rem;margin:12px 0}
.bottle-result-name{font-size:1.2rem;font-weight:800;color:#e2e8f0;margin-bottom:4px}
.bottle-result-detail{font-size:0.85rem;color:#64748b;margin-bottom:16px}
.quick-rate{margin-top:16px}
.quick-rate-label{font-size:0.75rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.quick-stars{display:flex;gap:8px;font-size:2.2rem;cursor:pointer;justify-content:center;margin-bottom:16px}
.quick-stars span{color:#1e293b;transition:color 0.15s}
.quick-stars span.active{color:#2dd4bf}
.quick-pills{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
.qpill{padding:10px 18px;border-radius:20px;border:1.5px solid rgba(45,212,191,0.2);background:transparent;color:#94a3b8;cursor:pointer;font-size:0.9rem;transition:all 0.15s}
.qpill.active{background:rgba(45,212,191,0.15);color:#2dd4bf;border-color:rgba(45,212,191,0.4)}
.save-bottle-btn{width:100%;padding:16px;border-radius:14px;border:none;background:linear-gradient(135deg,#2dd4bf,#06b6d4);color:#0a1628;font-size:1rem;font-weight:700;cursor:pointer;margin-top:12px}
.save-bottle-btn:disabled{opacity:0.4}
.save-bottle-btn:active{opacity:0.9}
.coll-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.coll-header h2{font-size:1.1rem;color:#e2e8f0}
.coll-header .coll-count{font-size:0.8rem;color:#2dd4bf}
.coll-search{width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid rgba(45,212,191,0.12);background:rgba(15,25,45,0.8);color:#e2e8f0;font-size:1rem;outline:none;margin-bottom:12px}
.coll-search:focus{border-color:rgba(45,212,191,0.35)}
.coll-search::placeholder{color:#334155}
.coll-tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.coll-tab{padding:7px 14px;border-radius:16px;border:1px solid rgba(45,212,191,0.15);background:transparent;color:#64748b;cursor:pointer;font-size:0.8rem;flex-shrink:0;white-space:nowrap}
.coll-tab.active{background:rgba(45,212,191,0.12);color:#2dd4bf;border-color:rgba(45,212,191,0.3)}
.wine-list{display:flex;flex-direction:column;gap:8px}
.wine-item{background:rgba(15,25,45,0.8);border:1.5px solid rgba(45,212,191,0.1);border-radius:12px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px}
.wine-item.top{border-left:3px solid #2dd4bf}
.wi-left{flex:1;min-width:0}
.wi-name{font-size:0.95rem;font-weight:700;color:#e2e8f0;margin-bottom:2px;line-height:1.3}
.wi-meta{font-size:0.78rem;color:#536178}
.wi-right{text-align:center;flex-shrink:0}
.wi-score{font-size:1.3rem;font-weight:800;color:#2dd4bf;line-height:1}
.wi-badge{font-size:0.6rem;color:#06b6d4;text-transform:uppercase;letter-spacing:0.3px}
.a-card{background:rgba(15,25,45,0.8);border:1.5px solid rgba(45,212,191,0.1);border-radius:12px;padding:14px 16px;margin-bottom:10px}
.a-card h3{font-size:0.85rem;color:#2dd4bf;margin-bottom:10px;font-weight:600}
.a-bar{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.a-label{font-size:0.75rem;color:#94a3b8;min-width:80px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.a-track{flex:1;height:6px;background:rgba(30,41,59,0.8);border-radius:3px;overflow:hidden}
.a-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#2dd4bf,#06b6d4)}
.a-val{font-size:0.7rem;color:#64748b;min-width:45px}
.insight-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(30,41,59,0.3);font-size:0.85rem}
.insight-row:last-child{border:none}
.insight-label{color:#94a3b8}
.insight-val{color:#2dd4bf;font-weight:700}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="screen active" id="screen-scan">
  <div class="scan-hero"><h1>üç∑ Hedonicum</h1><p>Your wine intelligence</p></div>
  <div id="scan-content"></div>
</div>
<div class="screen" id="screen-bottle"><div id="bottle-content"></div></div>
<div class="screen" id="screen-collection">
  <div class="coll-header"><h2>My Wines</h2><span class="coll-count" id="coll-count"></span></div>
  <input type="text" class="coll-search" id="coll-search" placeholder="Search wines...">
  <div class="coll-tabs" id="coll-tabs">
    <div class="coll-tab active" data-view="wines">All Wines</div>
    <div class="coll-tab" data-view="regions">Regions</div>
    <div class="coll-tab" data-view="grapes">Grapes</div>
    <div class="coll-tab" data-view="insights">Insights</div>
  </div>
  <div id="coll-content"></div>
</div>
<nav class="bottom-nav">
  <div class="nav-item active" data-screen="scan"><span class="nav-icon">üì∑</span>Scan</div>
  <div class="nav-item" data-screen="bottle" id="nav-bottle" onclick="startBottleScan()"><span class="nav-icon">üçæ</span>Add Wine</div>
  <div class="nav-item" data-screen="collection"><span class="nav-icon">üìö</span>Collection</div>
</nav>
<input type="file" id="menu-photo" accept="image/*" capture="environment" multiple>
<input type="file" id="bottle-photo" accept="image/*" capture="environment">
<script>
const SB_URL='https://bzpraigsuwgjgpnclcpd.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cHJhaWdzdXdnamdwbmNsY3BkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mzk2NDEsImV4cCI6MjA4NTExNTY0MX0.tBtsac6Mq65BiG93MhYtn1KV8iOGpEpVdlD3tqShrzE';
const API_KEY='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';
const hdrs={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
let wines=[],menuPhotos=[],menuResults=[],collView='wines',collSearch='';

function switchScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.querySelector(`.nav-item[data-screen="${name}"]`)?.classList.add('active');
  if(name==='collection')renderCollection();
  if(name==='scan')renderScanHome();
}
document.querySelectorAll('.nav-item').forEach(n=>{
  if(n.id==='nav-bottle')return;
  n.addEventListener('click',()=>switchScreen(n.dataset.screen));
});

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

async function loadWines(){
  try{const r=await fetch(`${SB_URL}/rest/v1/wines?select=*&order=rating.desc,name.asc&limit=1000`,{headers:hdrs});wines=await r.json();}catch(e){wines=[];}
}

function renderScanHome(){
  const el=document.getElementById('scan-content');
  if(menuPhotos.length===0&&menuResults.length===0){
    // Taste fingerprint
    const n=wines.length;
    const avg=n?(wines.reduce((s,w)=>s+Number(w.rating),0)/n).toFixed(1):'‚Äì';
    const top5=wines.filter(w=>Number(w.rating)>=5).length;
    const countries=new Set(wines.map(w=>w.country).filter(Boolean)).size;
    const regions=new Set(wines.map(w=>w.region).filter(Boolean)).size;
    // Top 3 grapes
    const gm={};wines.forEach(w=>{const g=w.grape;if(g){if(!gm[g])gm[g]=0;gm[g]++;}});
    const topGrapes=Object.entries(gm).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);
    // Top 3 regions
    const rm={};wines.forEach(w=>{const r=w.region;if(r){if(!rm[r])rm[r]=0;rm[r]++;}});
    const topRegions=Object.entries(rm).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]);

    el.innerHTML=`<div class="scan-cards">
      <div class="scan-card" onclick="document.getElementById('menu-photo').click()">
        <div class="scan-card-icon">üìã</div>
        <div class="scan-card-text"><h3>Scan Wine Menu</h3><p>Take photos of the menu and get instant pairing recommendations</p></div>
      </div>
      <div class="scan-card" onclick="startBottleScan()">
        <div class="scan-card-icon">üçæ</div>
        <div class="scan-card-text"><h3>Add a Bottle</h3><p>Snap the label to save it to your collection</p></div>
      </div>
    </div>
    ${n>0?`<div class="taste-card">
      <div class="taste-header">
        <div class="taste-title">Taste Profile</div>
        <div class="taste-subtitle">@Holdmybirra</div>
      </div>
      <div class="taste-stats">
        <div class="taste-stat"><div class="ts-num">${n}</div><div class="ts-label">wines</div></div>
        <div class="taste-stat"><div class="ts-num">${avg}</div><div class="ts-label">avg</div></div>
        <div class="taste-stat"><div class="ts-num">${top5}</div><div class="ts-label">5‚òÖ</div></div>
        <div class="taste-stat"><div class="ts-num">${countries}</div><div class="ts-label">countries</div></div>
      </div>
      ${topGrapes.length?`<div class="taste-tags"><span class="taste-tag-label">Top grapes</span>${topGrapes.map(g=>`<span class="taste-tag">${g}</span>`).join('')}</div>`:''}
      ${topRegions.length?`<div class="taste-tags"><span class="taste-tag-label">Top regions</span>${topRegions.map(r=>`<span class="taste-tag">${r}</span>`).join('')}</div>`:''}
    </div>`:''}`; 
  } else if(menuResults.length>0){renderScanResults(el);}
  else{renderScanPreview(el);}
}

function renderScanPreview(el){
  el.innerHTML=`<div class="photo-strip">
    ${menuPhotos.map((p,i)=>`<div class="photo-thumb"><img src="${p}"><div class="photo-thumb-num">${i+1}</div><div class="photo-thumb-x" onclick="removeMenuPhoto(${i})">‚úï</div></div>`).join('')}
    <div class="add-more-thumb" onclick="document.getElementById('menu-photo').click()">+</div>
  </div>
  <div class="pairing-section"><label>üçΩ What are you eating?</label>
    <input type="text" class="pairing-input" id="pairing-input" placeholder="steak, pasta, seafood, sushi...">
  </div>
  <button class="analyze-btn" onclick="analyzeMenu()">üîç Analyze ${menuPhotos.length} ${menuPhotos.length===1?'Photo':'Photos'}</button>
  <div class="clear-link" onclick="clearMenu()">Clear all</div>`;
}

function renderScanResults(el){
  const found=menuResults.filter(r=>r.match),notFound=menuResults.filter(r=>!r.match);
  const pairing=window._lastPairing||'';
  el.innerHTML=`<button class="analyze-btn" style="background:rgba(15,25,45,0.8);color:#2dd4bf;border:1.5px solid rgba(45,212,191,0.2)" onclick="clearMenu()">üì∑ Scan Another Menu</button>
    ${pairing?`<div style="text-align:center;color:#64748b;font-size:0.8rem;margin-top:8px">üçΩ Pairing with: <span style="color:#2dd4bf">${pairing}</span></div>`:''}
    ${found.length?`<div class="result-section"><div class="result-header">üéØ <span>${found.length}</span> wines you know</div>
      ${found.map(r=>`<div class="result-card matched"><div class="result-left">
        <div class="result-name">${r.menuName}</div>
        <div class="result-sub">${r.match.region||''}${r.match.grape?' ¬∑ '+r.match.grape:''}</div>
        ${r.match.notes?`<div class="result-sub" style="font-style:italic">"${r.match.notes}"</div>`:''}
        ${r.pairingNote?`<div class="result-pairing">üçΩ ${r.pairingNote}</div>`:''}
      </div><div class="result-right">
        <div class="result-score">${Number(r.match.rating).toFixed(1)}</div>
        ${r.match.reorder?`<div class="result-reorder ${r.match.reorder}">${r.match.reorder==='yes'?'‚úì Reorder':r.match.reorder==='no'?'‚úó Skip':'~ Maybe'}</div>`:''}
      </div></div>`).join('')}</div>`:''}
    ${notFound.length?`<div class="result-section"><div class="result-header">üÜï <span>${notFound.length}</span> new wines</div>
      ${notFound.map(r=>`<div class="result-card"><div class="result-left">
        <div class="result-name">${r.menuName}</div>
        ${r.pairingNote?`<div class="result-pairing">üçΩ ${r.pairingNote}</div>`:''}
        <div class="result-new">Not in your collection</div>
      </div></div>`).join('')}</div>`:''}`;
}

document.getElementById('menu-photo').addEventListener('change',e=>{
  Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>{menuPhotos.push(ev.target.result);renderScanHome();};r.readAsDataURL(f);});
  e.target.value='';
});
function removeMenuPhoto(i){menuPhotos.splice(i,1);if(!menuPhotos.length)menuResults=[];renderScanHome();}
function clearMenu(){menuPhotos=[];menuResults=[];window._lastPairing='';renderScanHome();}

async function analyzeMenu(){
  const pairing=document.getElementById('pairing-input')?.value||'';
  window._lastPairing=pairing;
  const el=document.getElementById('scan-content');
  el.innerHTML=`<div class="scan-status"><span class="spinner"></span>Reading ${menuPhotos.length} menu ${menuPhotos.length===1?'photo':'photos'}...</div>`;
  try{
    const content=[];
    menuPhotos.forEach(img=>{content.push({type:'image',source:{type:'base64',media_type:img.split(';')[0].split(':')[1],data:img.split(',')[1]}});});
    content.push({type:'text',text:`Extract ALL wine names from ${menuPhotos.length>1?'these menu photos':'this menu photo'}. Return ONLY a JSON array of strings with wine names exactly as written. Example: ["Ram√≥n Bilbao Reserva 2018","Catena Malbec 2020"]. No explanation, just JSON array.`});
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:2000,messages:[{role:'user',content}]})});
    if(!res.ok)throw new Error(res.status);
    const data=await res.json();
    let mw=[];try{mw=JSON.parse((data.content?.map(c=>c.text||'').join('')||'[]').replace(/```json|```/g,'').trim());}catch(e){}
    menuResults=mw.map(name=>({menuName:name,match:fuzzyMatch(name,wines),pairingNote:null}));
    if(pairing.trim()&&menuResults.length){
      el.innerHTML=`<div class="scan-status"><span class="spinner"></span>Matching with ${pairing}...</div>`;
      try{
        const pr=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:2000,messages:[{role:'user',content:`I'm eating: "${pairing}". Wines: ${JSON.stringify(mw)}. For each wine, give a very short pairing note (5-10 words). Return ONLY JSON object: {"Wine Name":"short note"}. No explanation.`}]})});
        if(pr.ok){const pd=await pr.json();try{const p=JSON.parse((pd.content?.map(c=>c.text||'').join('')||'{}').replace(/```json|```/g,'').trim());menuResults.forEach(r=>{if(p[r.menuName])r.pairingNote=p[r.menuName];});}catch(e){}}
      }catch(e){}
    }
    renderScanHome();
  }catch(e){console.error(e);toast('Error scanning menu');renderScanHome();}
}

function startBottleScan(){document.getElementById('bottle-photo').click();}

document.getElementById('bottle-photo').addEventListener('change',async e=>{
  const file=e.target.files[0];if(!file)return;e.target.value='';
  const reader=new FileReader();
  reader.onload=async ev=>{
    const img=ev.target.result;
    switchScreen('bottle');
    const el=document.getElementById('bottle-content');
    el.innerHTML=`<div class="bottle-flow"><div class="bottle-preview"><img src="${img}"></div><div class="bottle-status"><span class="spinner"></span>Reading label...</div></div>`;
    try{
      const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:500,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:img.split(';')[0].split(':')[1],data:img.split(',')[1]}},{type:'text',text:'Read this wine bottle label. Return ONLY JSON: {"name":"full wine name","region":"region","country":"country","grape":"grape or null","vintage":2020}. Use null for unknowns. No explanation.'}]}]})});
      if(!res.ok)throw new Error(res.status);
      const data=await res.json();
      let info={};try{info=JSON.parse((data.content?.map(c=>c.text||'').join('')||'{}').replace(/```json|```/g,'').trim());}catch(e){}
      renderBottleRate(el,img,info);
    }catch(err){console.error(err);renderBottleRate(el,img,{});}
  };
  reader.readAsDataURL(file);
});

function renderBottleRate(el,img,info){
  window._bi=info;window._br=0;window._bro='';
  el.innerHTML=`<div class="bottle-flow">
    <div class="bottle-preview"><img src="${img}"></div>
    ${info.name?`<div class="bottle-result-name">${info.name}</div><div class="bottle-result-detail">${[info.region,info.country,info.grape,info.vintage].filter(Boolean).join(' ¬∑ ')}</div>`
    :`<div class="bottle-result-detail">Could not read label</div><input type="text" class="pairing-input" id="bn-input" placeholder="Type wine name..." style="margin:10px 0">`}
    <div class="quick-rate">
      <div class="quick-rate-label">Your rating</div>
      <div class="quick-stars" id="b-stars"><span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span></div>
      <div class="quick-rate-label">Reorder?</div>
      <div class="quick-pills" id="b-reorder"><div class="qpill" data-v="yes">Yes</div><div class="qpill" data-v="maybe">Maybe</div><div class="qpill" data-v="no">No</div></div>
    </div>
    <button class="save-bottle-btn" id="save-btn" disabled onclick="saveBottle()">Save Wine</button>
    <div class="clear-link" onclick="switchScreen('scan')">Cancel</div>
  </div>`;
  document.querySelectorAll('#b-stars span').forEach(s=>s.addEventListener('click',()=>{
    window._br=Number(s.dataset.v);
    document.querySelectorAll('#b-stars span').forEach((x,i)=>x.classList.toggle('active',i<window._br));
    document.getElementById('save-btn').disabled=false;
  }));
  document.querySelectorAll('#b-reorder .qpill').forEach(p=>p.addEventListener('click',()=>{
    document.querySelectorAll('#b-reorder .qpill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');window._bro=p.dataset.v;
  }));
}

async function saveBottle(){
  const info=window._bi||{};
  const name=info.name||document.getElementById('bn-input')?.value?.trim();
  if(!name){toast('Enter a wine name');return;}
  const wine={name,region:info.region||null,country:info.country||null,grape:info.grape||null,vintage:info.vintage||null,rating:window._br,reorder:window._bro||null,source:'bottle_scan'};
  try{
    const res=await fetch(`${SB_URL}/rest/v1/wines`,{method:'POST',headers:{...hdrs,'Prefer':'return=representation'},body:JSON.stringify(wine)});
    if(res.ok){const[added]=await res.json();wines.unshift(added);wines.sort((a,b)=>Number(b.rating)-Number(a.rating));toast(`‚úì ${name} saved!`);switchScreen('scan');}
    else{toast('Error saving wine');}
  }catch(e){toast('Network error');}
}

function renderCollection(){
  document.getElementById('coll-count').textContent=`${wines.length} wines`;
  const q=collSearch.toLowerCase();
  const f=q?wines.filter(w=>(w.name||'').toLowerCase().includes(q)||(w.region||'').toLowerCase().includes(q)||(w.country||'').toLowerCase().includes(q)||(w.grape||'').toLowerCase().includes(q)):wines;
  const el=document.getElementById('coll-content');
  if(collView==='wines')renderCollWines(el,f);
  else if(collView==='regions')renderCollRegions(el,f);
  else if(collView==='grapes')renderCollGrapes(el,f);
  else renderCollInsights(el,f);
}
function renderCollWines(el,list){
  el.innerHTML=`<div class="wine-list">${list.map(w=>{const r=Number(w.rating);return`<div class="wine-item${r>=5?' top':''}"><div class="wi-left"><div class="wi-name">${w.name}</div><div class="wi-meta">${w.region||''}${w.grape?' ¬∑ '+w.grape:''}${w.vintage?' ¬∑ '+w.vintage:''}</div></div><div class="wi-right"><div class="wi-score">${r.toFixed(1)}</div><div class="wi-badge">${r>=5?'‚òÖ Top':r>=4.5?'Excellent':r>=4?'Great':'Good'}</div></div></div>`;}).join('')}</div>`;
}
function renderCollRegions(el,list){
  const m={};list.forEach(w=>{const r=w.region||'Unknown';if(!m[r])m[r]={n:0,t:0};m[r].n++;m[r].t+=Number(w.rating);});
  const s=Object.entries(m).sort((a,b)=>b[1].n-a[1].n),mx=s[0]?.[1].n||1;
  el.innerHTML=`<div class="a-card"><h3>Regions (${s.length})</h3>${s.slice(0,30).map(([n,d])=>`<div class="a-bar"><span class="a-label">${n}</span><div class="a-track"><div class="a-fill" style="width:${d.n/mx*100}%"></div></div><span class="a-val">${d.n} ¬∑ ${(d.t/d.n).toFixed(1)}‚òÖ</span></div>`).join('')}</div>`;
}
function renderCollGrapes(el,list){
  const m={};list.forEach(w=>{const g=w.grape||'Unknown';if(!m[g])m[g]={n:0,t:0};m[g].n++;m[g].t+=Number(w.rating);});
  const s=Object.entries(m).sort((a,b)=>b[1].n-a[1].n),mx=s[0]?.[1].n||1;
  el.innerHTML=`<div class="a-card"><h3>Grapes (${s.length})</h3>${s.slice(0,25).map(([n,d])=>`<div class="a-bar"><span class="a-label">${n}</span><div class="a-track"><div class="a-fill" style="width:${d.n/mx*100}%"></div></div><span class="a-val">${d.n} ¬∑ ${(d.t/d.n).toFixed(1)}‚òÖ</span></div>`).join('')}</div>`;
}
function renderCollInsights(el,list){
  const c={};list.forEach(w=>{const k=w.country||'Unknown';if(!c[k])c[k]=0;c[k]++;});
  const tc=Object.entries(c).sort((a,b)=>b[1]-a[1])[0];
  const avg=list.length?(list.reduce((s,w)=>s+Number(w.rating),0)/list.length).toFixed(2):'-';
  const t5=list.filter(w=>Number(w.rating)>=5).length;
  el.innerHTML=`<div class="a-card"><h3>Taste DNA</h3>
    <div class="insight-row"><span class="insight-label">Total wines</span><span class="insight-val">${list.length}</span></div>
    <div class="insight-row"><span class="insight-label">Average rating</span><span class="insight-val">${avg}</span></div>
    <div class="insight-row"><span class="insight-label">5‚òÖ wines</span><span class="insight-val">${t5} (${list.length?Math.round(t5/list.length*100):0}%)</span></div>
    <div class="insight-row"><span class="insight-label">Top country</span><span class="insight-val">${tc?tc[0]+' ('+tc[1]+')':'-'}</span></div>
    <div class="insight-row"><span class="insight-label">Regions</span><span class="insight-val">${new Set(list.map(w=>w.region).filter(Boolean)).size}</span></div>
    <div class="insight-row"><span class="insight-label">Countries</span><span class="insight-val">${Object.keys(c).length}</span></div>
  </div>`;
}
document.querySelectorAll('.coll-tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.coll-tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');collView=t.dataset.view;renderCollection();
}));
document.getElementById('coll-search').addEventListener('input',e=>{collSearch=e.target.value;renderCollection();});

function fuzzyMatch(query,wineList){
  const q=query.toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√±√º0-9\s]/gi,'').trim();
  const qw=q.split(/\s+/).filter(w=>w.length>2);
  let best=null,bs=0;
  for(const w of wineList){
    const n=(w.name||'').toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√±√º0-9\s]/gi,'').trim();
    if(n.includes(q)||q.includes(n))return w;
    const nw=n.split(/\s+/).filter(w=>w.length>2);let sc=0;
    for(const a of qw)for(const b of nw){if(b===a)sc+=3;else if(b.includes(a)||a.includes(b))sc+=2;else if(lev(a,b)<=2)sc+=1;}
    const ns=sc/Math.max(qw.length,nw.length,1);
    if(ns>bs&&ns>=1.5){bs=ns;best=w;}
  }return best;
}
function lev(a,b){const m=a.length,n=b.length,d=Array.from({length:m+1},(_,i)=>i);for(let j=1;j<=n;j++){let p=d[0];d[0]=j;for(let i=1;i<=m;i++){const t=d[i];d[i]=a[i-1]===b[j-1]?p:1+Math.min(p,d[i],d[i-1]);p=t;}}return d[m];}

loadWines().then(()=>renderScanHome());
</script>
</body>
</html>
