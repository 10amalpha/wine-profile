<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hedonicum</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#0a1628 0%,#0d1f3c 50%,#0a1628 100%);color:#e2e8f0;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}
header{text-align:center;padding:30px 0 20px}
header h1{font-size:1.8rem;background:linear-gradient(135deg,#2dd4bf,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
header p{color:#64748b;font-size:0.9rem}
.stats-bar{display:flex;gap:12px;justify-content:center;margin:16px 0 24px;flex-wrap:wrap}
.stat{background:rgba(15,32,53,0.8);border:1px solid rgba(45,212,191,0.15);border-radius:10px;padding:10px 18px;text-align:center}
.stat .num{font-size:1.4rem;font-weight:700;color:#2dd4bf}
.stat .label{font-size:0.7rem;color:#64748b;text-transform:uppercase;letter-spacing:0.5px}
.tabs{display:flex;gap:8px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:8px 20px;border-radius:20px;border:1px solid rgba(45,212,191,0.2);background:transparent;color:#94a3b8;cursor:pointer;font-size:0.85rem;transition:all 0.2s}
.tab.active,.tab:hover{background:rgba(45,212,191,0.15);color:#2dd4bf;border-color:rgba(45,212,191,0.4)}
.search-box{width:100%;max-width:500px;margin:0 auto 20px;display:block;padding:10px 16px;border-radius:10px;border:1px solid rgba(45,212,191,0.2);background:rgba(15,32,53,0.8);color:#e2e8f0;font-size:0.9rem;outline:none}
.search-box:focus{border-color:rgba(45,212,191,0.5)}
.search-box::placeholder{color:#475569}
.wine-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
.wine-card{background:rgba(15,32,53,0.8);border:1px solid rgba(45,212,191,0.1);border-radius:12px;padding:16px;transition:all 0.2s}
.wine-card:hover{border-color:rgba(45,212,191,0.3);transform:translateY(-1px)}
.wine-card.top{border-color:rgba(45,212,191,0.3)}
.wine-name{font-size:0.95rem;font-weight:600;color:#e2e8f0;margin-bottom:6px}
.wine-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
.wine-region{font-size:0.8rem;color:#64748b}
.wine-rating{display:flex;gap:2px}
.wine-rating .star{color:#2dd4bf;font-size:0.85rem}
.wine-rating .star.empty{color:#1e293b}
.wine-notes{font-size:0.8rem;color:#94a3b8;font-style:italic;margin-top:6px}
.badge{font-size:0.65rem;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.badge.tier5{background:rgba(45,212,191,0.2);color:#2dd4bf}
.badge.tier4{background:rgba(6,182,212,0.15);color:#06b6d4}
.badge.tier3{background:rgba(100,116,139,0.2);color:#94a3b8}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.analytics-card{background:rgba(15,32,53,0.8);border:1px solid rgba(45,212,191,0.1);border-radius:12px;padding:20px}
.analytics-card h3{font-size:0.9rem;color:#2dd4bf;margin-bottom:12px;font-weight:600}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-label{font-size:0.8rem;color:#94a3b8;min-width:120px;text-align:right}
.bar-track{flex:1;height:8px;background:rgba(30,41,59,0.8);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width 0.5s}
.bar-count{font-size:0.75rem;color:#64748b;min-width:30px}
.region-item,.grape-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(30,41,59,0.5)}
.region-item:last-child,.grape-item:last-child{border:none}
.region-name,.grape-name{font-size:0.85rem;color:#e2e8f0}
.region-count,.grape-count{font-size:0.8rem;color:#2dd4bf;font-weight:600}
.region-avg,.grape-avg{font-size:0.75rem;color:#64748b}
/* Add Wine Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:linear-gradient(135deg,#0f2035,#0d1f3c);border:1px solid rgba(45,212,191,0.2);border-radius:16px;padding:28px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal h2{color:#2dd4bf;font-size:1.2rem;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:0.8rem;color:#94a3b8;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,191,0.2);background:rgba(10,22,40,0.8);color:#e2e8f0;font-size:0.9rem;outline:none}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:rgba(45,212,191,0.5)}
.form-group textarea{resize:vertical;min-height:60px}
.star-input{display:flex;gap:6px;font-size:1.5rem;cursor:pointer}
.star-input span{color:#1e293b;transition:color 0.15s}
.star-input span.active{color:#2dd4bf}
.star-input span:hover,.star-input span:hover~span{color:rgba(45,212,191,0.5)}
.pill-group{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 16px;border-radius:20px;border:1px solid rgba(45,212,191,0.2);background:transparent;color:#94a3b8;cursor:pointer;font-size:0.85rem;transition:all 0.2s}
.pill.selected{background:rgba(45,212,191,0.15);color:#2dd4bf;border-color:rgba(45,212,191,0.4)}
.btn-row{display:flex;gap:10px;margin-top:20px}
.btn{padding:10px 24px;border-radius:10px;border:none;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.2s}
.btn-primary{background:linear-gradient(135deg,#2dd4bf,#06b6d4);color:#0a1628}
.btn-primary:hover{opacity:0.9;transform:translateY(-1px)}
.btn-secondary{background:transparent;border:1px solid rgba(100,116,139,0.3);color:#94a3b8}
.btn-secondary:hover{border-color:rgba(45,212,191,0.3);color:#e2e8f0}
.fab{position:fixed;bottom:28px;right:28px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#2dd4bf,#06b6d4);border:none;color:#0a1628;font-size:1.8rem;cursor:pointer;box-shadow:0 4px 20px rgba(45,212,191,0.3);z-index:50;display:flex;align-items:center;justify-content:center;transition:transform 0.2s}
.fab:hover{transform:scale(1.1)}
.loading{text-align:center;padding:60px;color:#64748b}
@media(max-width:600px){.wine-grid{grid-template-columns:1fr}.analytics-grid{grid-template-columns:1fr}.stats-bar{gap:8px}.stat{padding:8px 12px}}
/* Scan Menu */
.scan-tab{background:rgba(45,212,191,0.1);border-color:rgba(45,212,191,0.3)}
.scan-view{max-width:600px;margin:0 auto}
.scan-upload{border:2px dashed rgba(45,212,191,0.3);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.2s;background:rgba(15,32,53,0.6)}
.scan-upload:hover,.scan-upload:active{border-color:rgba(45,212,191,0.6);background:rgba(15,32,53,0.9)}
.scan-upload input{display:none}
.scan-icon{font-size:3rem;margin-bottom:12px}
.scan-title{font-size:1rem;font-weight:600;color:#2dd4bf;margin-bottom:6px}
.scan-hint{font-size:0.8rem;color:#64748b}
.scan-preview{position:relative;margin:16px 0;border-radius:12px;overflow:hidden}
.scan-preview img{width:100%;display:block;border-radius:12px}
.scan-actions{display:flex;gap:10px;margin:16px 0}
.scan-actions .btn{flex:1;text-align:center;padding:14px;font-size:0.95rem}
.scan-status{text-align:center;padding:20px;color:#94a3b8;font-size:0.9rem}
.scan-status .spinner{display:inline-block;width:20px;height:20px;border:2px solid rgba(45,212,191,0.3);border-top-color:#2dd4bf;border-radius:50%;animation:spin 0.8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.match-list{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.match-card{background:rgba(15,32,53,0.8);border:1px solid rgba(45,212,191,0.15);border-radius:12px;padding:14px;display:flex;justify-content:space-between;align-items:center}
.match-card.found{border-color:rgba(45,212,191,0.4)}
.match-card.not-found{border-color:rgba(100,116,139,0.2);opacity:0.7}
.match-info{flex:1}
.match-name{font-size:0.9rem;font-weight:600;color:#e2e8f0;margin-bottom:4px}
.match-detail{font-size:0.78rem;color:#64748b}
.match-rating{text-align:right;min-width:80px}
.match-stars{color:#2dd4bf;font-size:0.85rem}
.match-reorder{font-size:0.7rem;margin-top:2px}
.match-reorder.yes{color:#2dd4bf}
.match-reorder.no{color:#ef4444}
.match-reorder.maybe{color:#f59e0b}
.match-new{font-size:0.75rem;color:#64748b;font-style:italic}
.menu-wines-header{font-size:0.85rem;color:#94a3b8;margin:20px 0 10px;padding-bottom:8px;border-bottom:1px solid rgba(30,41,59,0.5)}
.menu-wines-header span{color:#2dd4bf;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>üç∑ Hedonicum</h1>
    <p>@Holdmybirra ‚Äî <span id="wine-count">0</span> wines rated</p>
  </header>
  <div class="stats-bar" id="stats-bar"></div>
  <div class="tabs">
    <button class="tab active" data-tab="wines">Wines</button>
    <button class="tab" data-tab="regions">Regions</button>
    <button class="tab" data-tab="grapes">Grapes</button>
    <button class="tab" data-tab="insights">Insights</button>
    <button class="tab scan-tab" data-tab="scan">üì∑ Scan Menu</button>
  </div>
  <input type="text" class="search-box" id="search" placeholder="Search wines, regions, grapes...">
  <div id="content"><div class="loading">Loading wines...</div></div>
</div>

<button class="fab" onclick="openAddWine()">+</button>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>Add Wine</h2>
    <div class="form-group">
      <label>Wine Name</label>
      <input type="text" id="f-name" placeholder="e.g. Ram√≥n Bilbao Reserva 2018">
    </div>
    <div class="form-group">
      <label>Region</label>
      <input type="text" id="f-region" placeholder="e.g. Rioja, Spain">
    </div>
    <div class="form-group">
      <label>Country</label>
      <input type="text" id="f-country" placeholder="e.g. Spain">
    </div>
    <div class="form-group">
      <label>Grape</label>
      <input type="text" id="f-grape" placeholder="e.g. Tempranillo">
    </div>
    <div class="form-group">
      <label>Vintage</label>
      <input type="number" id="f-vintage" placeholder="e.g. 2018">
    </div>
    <div class="form-group">
      <label>Rating</label>
      <div class="star-input" id="star-input">
        <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
      </div>
    </div>
    <div class="form-group">
      <label>Would you reorder?</label>
      <div class="pill-group" id="reorder-pills">
        <div class="pill" data-v="yes">Yes</div>
        <div class="pill" data-v="maybe">Maybe</div>
        <div class="pill" data-v="no">No</div>
      </div>
    </div>
    <div class="form-group">
      <label>Occasion</label>
      <div class="pill-group" id="occasion-pills">
        <div class="pill" data-v="casual">Casual</div>
        <div class="pill" data-v="date">Date</div>
        <div class="pill" data-v="celebration">Celebration</div>
        <div class="pill" data-v="pairing">Pairing</div>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="f-notes" placeholder="Tasting notes, pairing, mood..."></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="saveWine()">Save Wine</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://bzpraigsuwgjgpnclcpd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cHJhaWdzdXdnamdwbmNsY3BkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Mzk2NDEsImV4cCI6MjA4NTExNTY0MX0.tBtsac6Mq65BiG93MhYtn1KV8iOGpEpVdlD3tqShrzE';

let wines = [];
let currentTab = 'wines';
let searchTerm = '';
let formRating = 0;
let formReorder = '';
let formOccasion = '';

const headers = {'apikey':SUPABASE_KEY,'Authorization':'Bearer '+SUPABASE_KEY,'Content-Type':'application/json'};

async function loadWines() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/wines?select=*&order=rating.desc,name.asc&limit=1000`, {headers});
    wines = await res.json();
    document.getElementById('wine-count').textContent = wines.length;
    renderStats();
    render();
  } catch(e) { document.getElementById('content').innerHTML = '<div class="loading">Error loading wines</div>'; }
}

function renderStats() {
  const avg = wines.length ? (wines.reduce((s,w)=>s+Number(w.rating),0)/wines.length).toFixed(1) : 0;
  const countries = new Set(wines.map(w=>w.country).filter(Boolean));
  const regions = new Set(wines.map(w=>w.region).filter(Boolean));
  const top = wines.filter(w=>Number(w.rating)>=5).length;
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat"><div class="num">${wines.length}</div><div class="label">Wines</div></div>
    <div class="stat"><div class="num">${avg}</div><div class="label">Avg Rating</div></div>
    <div class="stat"><div class="num">${countries.size}</div><div class="label">Countries</div></div>
    <div class="stat"><div class="num">${regions.size}</div><div class="label">Regions</div></div>
    <div class="stat"><div class="num">${top}</div><div class="label">5‚òÖ Wines</div></div>`;
}

function render() {
  const el = document.getElementById('content');
  const q = searchTerm.toLowerCase();
  const filtered = q ? wines.filter(w => 
    (w.name||'').toLowerCase().includes(q) || 
    (w.region||'').toLowerCase().includes(q) || 
    (w.country||'').toLowerCase().includes(q) ||
    (w.grape||'').toLowerCase().includes(q)
  ) : wines;

  if (currentTab === 'wines') renderWines(el, filtered);
  else if (currentTab === 'regions') renderRegions(el, filtered);
  else if (currentTab === 'grapes') renderGrapes(el, filtered);
  else if (currentTab === 'scan') renderScan(el);
  else renderInsights(el, filtered);
}

function stars(r) {
  const full = Math.floor(r);
  const half = r % 1 >= 0.25;
  let s = '';
  for(let i=0;i<5;i++) s += `<span class="star${i<full||(i===full&&half)?' ':' empty'}">${i<full?'‚òÖ':(i===full&&half?'‚òÖ':'‚òÖ')}</span>`;
  return s;
}

function tierBadge(r) {
  if(r>=5) return '<span class="badge tier5">‚òÖ Top</span>';
  if(r>=4.5) return '<span class="badge tier4">Excellent</span>';
  if(r>=4) return '<span class="badge tier4">Great</span>';
  return '<span class="badge tier3">Good</span>';
}

function renderWines(el, list) {
  el.innerHTML = `<div class="wine-grid">${list.map(w => `
    <div class="wine-card${Number(w.rating)>=5?' top':''}">
      <div class="wine-name">${w.name}</div>
      <div class="wine-meta">
        <div class="wine-rating">${stars(Number(w.rating))}</div>
        ${tierBadge(Number(w.rating))}
      </div>
      <div class="wine-region">${w.region||''}${w.grape?' ¬∑ '+w.grape:''}${w.vintage?' ¬∑ '+w.vintage:''}</div>
      ${w.notes?`<div class="wine-notes">"${w.notes}"</div>`:''}
    </div>`).join('')}</div>`;
}

function renderRegions(el, list) {
  const map = {};
  list.forEach(w => {
    const r = w.region || 'Unknown';
    if(!map[r]) map[r] = {wines:[], total:0};
    map[r].wines.push(w);
    map[r].total += Number(w.rating);
  });
  const sorted = Object.entries(map).sort((a,b) => b[1].wines.length - a[1].wines.length);
  const max = sorted[0]?.[1].wines.length || 1;
  el.innerHTML = `<div class="analytics-grid"><div class="analytics-card" style="grid-column:1/-1">
    <h3>Regions by Count (${sorted.length} regions)</h3>
    ${sorted.slice(0,30).map(([name,d]) => {
      const avg = (d.total/d.wines.length).toFixed(1);
      const pct = (d.wines.length/max*100);
      return `<div class="bar-row">
        <span class="bar-label">${name}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,#2dd4bf,#06b6d4)"></div></div>
        <span class="bar-count">${d.wines.length} (${avg}‚òÖ)</span>
      </div>`;
    }).join('')}
  </div></div>`;
}

function renderGrapes(el, list) {
  const map = {};
  list.forEach(w => {
    const g = w.grape || 'Unknown';
    if(!map[g]) map[g] = {count:0, total:0};
    map[g].count++;
    map[g].total += Number(w.rating);
  });
  const sorted = Object.entries(map).sort((a,b) => b[1].count - a[1].count);
  const max = sorted[0]?.[1].count || 1;
  el.innerHTML = `<div class="analytics-grid"><div class="analytics-card" style="grid-column:1/-1">
    <h3>Grapes (${sorted.length} varieties)</h3>
    ${sorted.slice(0,25).map(([name,d]) => {
      const avg = (d.total/d.count).toFixed(1);
      const pct = (d.count/max*100);
      return `<div class="bar-row">
        <span class="bar-label">${name}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,#06b6d4,#2dd4bf)"></div></div>
        <span class="bar-count">${d.count} (${avg}‚òÖ)</span>
      </div>`;
    }).join('')}
  </div></div>`;
}

function renderInsights(el, list) {
  const countries = {};
  list.forEach(w => {
    const c = w.country || 'Unknown';
    if(!countries[c]) countries[c] = {count:0,total:0};
    countries[c].count++;
    countries[c].total += Number(w.rating);
  });
  const cSorted = Object.entries(countries).sort((a,b)=>b[1].count-a[1].count);
  const cMax = cSorted[0]?.[1].count || 1;

  const ratingDist = [0,0,0,0,0];
  list.forEach(w => {
    const r = Math.round(Number(w.rating));
    if(r>=1&&r<=5) ratingDist[r-1]++;
  });
  const rdMax = Math.max(...ratingDist) || 1;

  el.innerHTML = `<div class="analytics-grid">
    <div class="analytics-card">
      <h3>Countries (${cSorted.length})</h3>
      ${cSorted.map(([name,d])=>{
        const avg=(d.total/d.count).toFixed(1);
        const pct=(d.count/cMax*100);
        return `<div class="bar-row">
          <span class="bar-label">${name}</span>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,#2dd4bf,#06b6d4)"></div></div>
          <span class="bar-count">${d.count} (${avg}‚òÖ)</span>
        </div>`;
      }).join('')}
    </div>
    <div class="analytics-card">
      <h3>Rating Distribution</h3>
      ${ratingDist.map((c,i)=>{
        const pct=(c/rdMax*100);
        return `<div class="bar-row">
          <span class="bar-label">${i+1}‚òÖ</span>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:linear-gradient(90deg,${i>=3?'#2dd4bf':i>=2?'#06b6d4':'#64748b'},${i>=3?'#06b6d4':i>=2?'#2dd4bf':'#94a3b8'})"></div></div>
          <span class="bar-count">${c}</span>
        </div>`;
      }).join('')}
    </div>
    <div class="analytics-card">
      <h3>Taste DNA</h3>
      <div style="font-size:0.85rem;color:#94a3b8;line-height:1.8">
        <div>üèÜ Top country: <strong style="color:#2dd4bf">${cSorted[0]?.[0]||'-'}</strong> (${cSorted[0]?.[1].count||0} wines)</div>
        <div>‚≠ê Average rating: <strong style="color:#2dd4bf">${list.length?(list.reduce((s,w)=>s+Number(w.rating),0)/list.length).toFixed(2):'-'}</strong></div>
        <div>üç∑ 5-star wines: <strong style="color:#2dd4bf">${list.filter(w=>Number(w.rating)>=5).length}</strong> (${list.length?Math.round(list.filter(w=>Number(w.rating)>=5).length/list.length*100):0}%)</div>
        <div>üåç Countries explored: <strong style="color:#2dd4bf">${cSorted.length}</strong></div>
        <div>üìç Regions explored: <strong style="color:#2dd4bf">${new Set(list.map(w=>w.region).filter(Boolean)).size}</strong></div>
      </div>
    </div>
  </div>`;
}

// === SCAN MENU ===
let scanState = 'idle'; // idle, preview, scanning, results
let scanImage = null;
let scanResults = [];

function renderScan(el) {
  if(scanState === 'idle') {
    el.innerHTML = `<div class="scan-view">
      <div class="scan-upload" onclick="document.getElementById('menu-photo').click()">
        <input type="file" id="menu-photo" accept="image/*" capture="environment" onchange="handleMenuPhoto(event)">
        <div class="scan-icon">üì∑</div>
        <div class="scan-title">Scan Wine Menu</div>
        <div class="scan-hint">Take a photo or upload an image of the wine list</div>
      </div>
    </div>`;
  } else if(scanState === 'preview') {
    el.innerHTML = `<div class="scan-view">
      <div class="scan-preview"><img src="${scanImage}" alt="Menu"></div>
      <div class="scan-actions">
        <button class="btn btn-primary" onclick="analyzeMenu()">üîç Analyze Menu</button>
        <button class="btn btn-secondary" onclick="resetScan()">‚Ü© Retake</button>
      </div>
    </div>`;
  } else if(scanState === 'scanning') {
    el.innerHTML = `<div class="scan-view">
      <div class="scan-preview"><img src="${scanImage}" alt="Menu" style="opacity:0.5"></div>
      <div class="scan-status"><span class="spinner"></span>Reading wine menu...</div>
    </div>`;
  } else if(scanState === 'results') {
    const found = scanResults.filter(r => r.match);
    const notFound = scanResults.filter(r => !r.match);
    el.innerHTML = `<div class="scan-view">
      <div class="scan-actions">
        <button class="btn btn-primary" onclick="resetScan()">üì∑ Scan Another</button>
      </div>
      ${found.length ? `<div class="menu-wines-header">üéØ <span>${found.length}</span> wines you've rated</div>
      <div class="match-list">${found.map(r => `
        <div class="match-card found">
          <div class="match-info">
            <div class="match-name">${r.menuName}</div>
            <div class="match-detail">${r.match.region||''} ${r.match.grape?' ¬∑ '+r.match.grape:''}</div>
            ${r.match.notes?`<div class="match-detail" style="font-style:italic;color:#94a3b8">"${r.match.notes}"</div>`:''}
          </div>
          <div class="match-rating">
            <div class="match-stars">${'‚òÖ'.repeat(Math.floor(r.match.rating))}${'‚òÜ'.repeat(5-Math.floor(r.match.rating))}</div>
            ${r.match.reorder?`<div class="match-reorder ${r.match.reorder}">${r.match.reorder==='yes'?'‚úì Reorder':r.match.reorder==='no'?'‚úó Skip':'~ Maybe'}</div>`:''}
          </div>
        </div>`).join('')}</div>`:''}
      ${notFound.length ? `<div class="menu-wines-header">üÜï <span>${notFound.length}</span> new wines</div>
      <div class="match-list">${notFound.map(r => `
        <div class="match-card not-found">
          <div class="match-info">
            <div class="match-name">${r.menuName}</div>
            <div class="match-new">Not in your collection</div>
          </div>
        </div>`).join('')}</div>`:''}
    </div>`;
  }
}

function handleMenuPhoto(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    scanImage = ev.target.result;
    scanState = 'preview';
    render();
  };
  reader.readAsDataURL(file);
}

function resetScan() {
  scanState = 'idle';
  scanImage = null;
  scanResults = [];
  render();
}

async function analyzeMenu() {
  const apiKey = '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';
  scanState = 'scanning';
  render();
  try {
    const base64 = scanImage.split(',')[1];
    const mediaType = scanImage.split(';')[0].split(':')[1];
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: [
            {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
            {type:'text',text:'Extract ALL wine names from this menu image. Return ONLY a JSON array of strings with the wine names exactly as written. Example: ["Ram√≥n Bilbao Reserva 2018","Catena Malbec 2020"]. If you cannot read any wines, return []. No explanation, just the JSON array.'}
          ]
        }]
      })
    });
    if(!response.ok) {
      throw new Error('API error: ' + response.status);
    }
    const data = await response.json();
    const text = data.content?.map(c=>c.text||'').join('') || '[]';
    const cleaned = text.replace(/```json|```/g,'').trim();
    let menuWines = [];
    try { menuWines = JSON.parse(cleaned); } catch(e) { menuWines = []; }
    
    // Fuzzy match against our DB
    scanResults = menuWines.map(menuName => {
      const match = fuzzyMatch(menuName, wines);
      return { menuName, match };
    });
    
    scanState = 'results';
  } catch(e) {
    console.error('Scan error:', e);
    alert('Error scanning menu. Check your connection.');
    scanState = 'preview';
  }
  render();
}

function fuzzyMatch(query, wineList) {
  const q = query.toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√±√º0-9\s]/gi,'').trim();
  const qWords = q.split(/\s+/).filter(w => w.length > 2);
  let bestMatch = null;
  let bestScore = 0;
  
  for(const w of wineList) {
    const name = (w.name||'').toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√±√º0-9\s]/gi,'').trim();
    // Exact substring match
    if(name.includes(q) || q.includes(name)) return w;
    // Word overlap scoring
    const nameWords = name.split(/\s+/).filter(w => w.length > 2);
    let score = 0;
    for(const qw of qWords) {
      for(const nw of nameWords) {
        if(nw === qw) score += 3;
        else if(nw.includes(qw) || qw.includes(nw)) score += 2;
        else if(levenshtein(nw,qw) <= 2) score += 1;
      }
    }
    const normalizedScore = score / Math.max(qWords.length, nameWords.length, 1);
    if(normalizedScore > bestScore && normalizedScore >= 1.5) {
      bestScore = normalizedScore;
      bestMatch = w;
    }
  }
  return bestMatch;
}

function levenshtein(a,b) {
  const m = a.length, n = b.length;
  const d = Array.from({length:m+1},(_,i)=>i);
  for(let j=1;j<=n;j++) {
    let prev = d[0]; d[0] = j;
    for(let i=1;i<=m;i++) {
      const temp = d[i];
      d[i] = a[i-1]===b[j-1] ? prev : 1+Math.min(prev,d[i],d[i-1]);
      prev = temp;
    }
  }
  return d[m];
}

// Tabs
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  currentTab = t.dataset.tab;
  document.getElementById('search').style.display = currentTab==='scan'?'none':'block';
  document.getElementById('stats-bar').style.display = currentTab==='scan'?'none':'flex';
  render();
}));

// Search
document.getElementById('search').addEventListener('input', e => {
  searchTerm = e.target.value;
  render();
});

// Add Wine
function openAddWine() {
  document.getElementById('modal').classList.add('show');
  formRating = 0; formReorder = ''; formOccasion = '';
  document.querySelectorAll('#star-input span').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('selected'));
  document.querySelectorAll('.modal input, .modal textarea').forEach(i=>i.value='');
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }

// Stars
document.querySelectorAll('#star-input span').forEach(s => {
  s.addEventListener('click', () => {
    formRating = Number(s.dataset.v);
    document.querySelectorAll('#star-input span').forEach((x,i) => {
      x.classList.toggle('active', i < formRating);
    });
  });
});

// Pills
document.querySelectorAll('#reorder-pills .pill').forEach(p => p.addEventListener('click', () => {
  document.querySelectorAll('#reorder-pills .pill').forEach(x=>x.classList.remove('selected'));
  p.classList.add('selected');
  formReorder = p.dataset.v;
}));
document.querySelectorAll('#occasion-pills .pill').forEach(p => p.addEventListener('click', () => {
  document.querySelectorAll('#occasion-pills .pill').forEach(x=>x.classList.remove('selected'));
  p.classList.add('selected');
  formOccasion = p.dataset.v;
}));

async function saveWine() {
  const name = document.getElementById('f-name').value.trim();
  if(!name || !formRating) { alert('Name and rating required'); return; }
  const wine = {
    name,
    region: document.getElementById('f-region').value.trim() || null,
    country: document.getElementById('f-country').value.trim() || null,
    grape: document.getElementById('f-grape').value.trim() || null,
    vintage: document.getElementById('f-vintage').value ? Number(document.getElementById('f-vintage').value) : null,
    rating: formRating,
    reorder: formReorder || null,
    occasion: formOccasion || null,
    notes: document.getElementById('f-notes').value.trim() || null,
    source: 'manual'
  };
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/wines`, {
      method:'POST', headers:{...headers,'Prefer':'return=representation'},
      body: JSON.stringify(wine)
    });
    if(res.ok) {
      const [added] = await res.json();
      wines.unshift(added);
      wines.sort((a,b)=>Number(b.rating)-Number(a.rating)||(a.name||'').localeCompare(b.name||''));
      document.getElementById('wine-count').textContent = wines.length;
      renderStats();
      render();
      closeModal();
    } else { alert('Error saving: ' + (await res.text())); }
  } catch(e) { alert('Network error'); }
}

// Close modal on overlay click
document.getElementById('modal').addEventListener('click', e => {
  if(e.target === document.getElementById('modal')) closeModal();
});

loadWines();
</script>
</body>
</html>
